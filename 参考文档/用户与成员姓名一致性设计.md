# 用户与成员姓名一致性设计

## 需求说明

微信用户可作为不同家谱的多个成员，但用户的昵称和姓名应该保持一致，避免姓名不统一导致查找困难。

## 数据模型

### User 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| nickname | varchar(50) | 微信昵称 |
| name | varchar(50) | 真实姓名（全局统一） |
| openid | varchar(100) | 微信OpenID |
| ... | ... | 其他字段 |

### Member 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| genealogy_id | bigint | 家谱ID |
| name | varchar(50) | 成员姓名 |
| user_id | bigint | 关联用户ID（可为空） |
| ... | ... | 其他字段 |

## 核心逻辑

### 1. 用户注册/登录时

```java
// 微信登录时，如果用户存在，自动同步昵称和姓名到成员
public void wxLogin(WxLoginRequest request) {
    User user = userMapper.selectByOpenid(request.getOpenid());
    
    if (user != null) {
        // 更新昵称（可能变化）
        if (request.getNickname() != null) {
            user.setNickname(request.getNickname());
        }
        
        // 同步成员姓名
        syncMemberName(user.getId(), user.getName());
        userMapper.updateById(user);
    }
}
```

### 2. 用户修改姓名时

```java
@Transactional
public void updateUserName(Long userId, String newName) {
    // 1. 更新用户姓名
    User user = userMapper.selectById(userId);
    user.setName(newName);
    userMapper.updateById(user);
    
    // 2. 同步更新所有家谱中的成员姓名
    List<Member> members = memberMapper.selectList(
        new LambdaQueryWrapper<Member>()
            .eq(Member::getUserId, userId)
    );
    
    for (Member member : members) {
        member.setName(newName);
        memberMapper.updateById(member);
    }
    
    // 3. 清除相关缓存
    evictUserCache(userId);
    for (Member member : members) {
        evictMemberCache(member.getGenealogyId());
    }
}
```

### 3. 新增成员时（关联用户）

```java
public Result<Member> addMember(AddMemberRequest request, Long familyId) {
    // 如果关联了用户，自动填充用户姓名
    if (request.getUserId() != null) {
        User user = userMapper.selectById(request.getUserId());
        if (user != null && user.getName() != null) {
            request.setName(user.getName());
        }
    }
    
    Member member = buildMember(request, familyId);
    memberMapper.insert(member);
    
    return Result.success(member);
}
```

### 4. 管理员修改成员姓名时

```java
public Result<Void> updateMember(Long memberId, UpdateMemberRequest request) {
    Member member = memberMapper.selectById(memberId);
    
    // 如果成员关联了用户，禁止直接修改姓名
    if (member.getUserId() != null && request.getName() != null) {
        throw new BusinessException("该成员已关联用户账号，姓名不允许直接修改，请通过用户管理修改");
    }
    
    // 未关联用户的成员，可以直接修改
    BeanUtils.copyProperties(request, member);
    memberMapper.updateById(member);
    
    return Result.success();
}
```

## 接口设计

### 修改用户姓名

**接口路径**：`PUT /api/user/name`

**请求参数**：
```json
{
  "name": "张三"
}
```

**响应结构**：
```json
{
  "code": 200,
  "message": "姓名修改成功，已同步到所有家谱",
  "data": null
}
```

**业务规则**：
1. 姓名字段全局唯一校验
2. 同步更新所有关联成员
3. 记录操作日志

## 前端交互

### 用户端

- 修改姓名时弹窗提示："修改后将同步更新您所在所有家谱中的姓名"
- 展示用户的统一姓名

### 管理后台

- 查看成员时，显示是否关联用户
- 关联用户的成员，姓名字段禁用直接编辑
- 提示："该成员已关联用户账号"

## 总结

| 场景 | 处理方式 |
|------|----------|
| 用户修改姓名 | 自动同步到所有家谱成员 |
| 管理员修改关联用户的成员姓名 | 禁止，需提示通过用户管理修改 |
| 管理员修改未关联用户的成员姓名 | 允许 |
| 新增关联用户的成员 | 自动填充用户姓名 |
