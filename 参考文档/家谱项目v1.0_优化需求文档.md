# 家谱项目 v1.0 功能优化需求文档

**文档版本**：v1.0.2
**创建日期**：2026-02-21
**文档状态**：待评审
**产品负责人**：待定
**适用范围**：后台管理系统 & 微信小程序端

---

## 目录

1. [背景与目标](#1-背景与目标)
2. [用户角色模块优化](#2-用户角色模块优化)
3. [家谱管理模块优化](#3-家谱管理模块优化)
4. [成员管理模块优化](#4-成员管理模块优化)
5. [审批管理模块优化](#5-审批管理模块优化)
6. [小程序家谱成员管理模块优化](#6-小程序家谱成员管理模块优化)
7. [数据模型变更说明](#7-数据模型变更说明)
8. [权限矩阵](#8-权限矩阵)
9. [非功能性需求](#9-非功能性需求)
10. [开放问题与风险](#10-开放问题与风险)
11. [安全性优化](#11-安全性优化)
12. [功能补充优化](#12-功能补充优化)
13. [代码质量优化](#13-代码质量优化)
14. [架构优化](#14-架构优化)
15. [性能优化](#15-性能优化)
16. [用户体验优化](#16-用户体验优化)
17. [优化优先级排期](#17-优化优先级排期)

---

## 1. 背景与目标

### 1.1 背景

当前家谱项目 v1.0 已完成基础功能搭建，但在用户权限体系、数据管理操作易用性等方面存在较多待完善点，影响管理员日常操作效率及用户体验。

### 1.2 优化目标

- 建立清晰的三层用户角色体系，明确各角色权限边界
- 提升后台管理系统的数据查询与操作效率
- 完善审批流程的信息可见性
- 增强小程序端成员树状管理能力

### 1.3 术语定义

| 术语 | 说明 |
|------|------|
| 超级管理员 | 平台最高权限账号，可管理所有家谱及用户 |
| 家谱管理员 | 拥有一个或多个家谱管理权的用户 |
| 普通用户 | 仅能查看所在家谱信息的基础用户 |
| 成员 | 家谱中录入的人员信息，与"用户"账号为不同概念 |
| 用户-成员关联 | 同一自然人在系统中同时拥有"用户账号"与"家谱成员身份" |

---

## 2. 用户角色模块优化

### 2.1 角色体系设计

系统设置三种用户角色，各角色职责与权限严格隔离：

| 角色 | 归属范围 | 访问入口 | 核心职责 |
|------|----------|----------|----------|
| 超级管理员 | 平台级，不属于任何家谱 | 后台管理系统 | 管理所有家谱、用户、成员信息 |
| 家谱管理员 | 一个或多个家谱 | 微信小程序「我的家谱」 | 管理所辖家谱及其成员 |
| 普通用户 | 所属家谱（只读） | 微信小程序 | 查看家谱信息，申请操作需审批 |

> **设计说明**：用户角色为"全局最高角色取值"——只要用户在任意一个家谱担任家谱管理员，其账号角色即标记为"家谱管理员"；当其在所有家谱均不再担任管理员时，自动降级为普通用户。

### 2.2 角色获取与变更规则

#### 2.2.1 家谱管理员的产生方式

- **创建家谱时**：创建家谱的第一个用户自动成为该家谱的家谱管理员
- **管理员邀请**：家谱管理员可在小程序内将普通用户设置为本家谱的共同管理员
- **超级管理员操作**：超级管理员可在后台直接修改某用户在指定家谱中的角色

#### 2.2.2 角色降级保护规则

- 超级管理员将某用户设置为普通用户时，该用户将失去**所有家谱**的管理权限
- **保护机制**：若目标用户是某一家谱的**唯一管理员**，则禁止执行降级操作，系统需给出提示：
  
  > "该用户是「{家谱名称}」的唯一管理员，请先为该家谱指定其他管理员后再操作。"
- 若用户同时管理多个家谱，降级后所有家谱管理权一并撤销

#### 2.2.3 用户与成员的关系说明

- 用户（User）与成员（Member）是两个独立的数据实体
- 一个用户可以是多个家谱中的成员
- 用户在某一家谱中的角色（管理员/普通用户）与其成员身份相互独立，需分别维护

### 2.3 超级管理员——用户管理功能

#### 2.3.1 用户列表

- 支持按角色（家谱管理员 / 普通用户）筛选
- 列表展示字段：用户昵称、手机号/OpenID、账号角色、所属家谱数量、注册时间、最后登录时间
- 点击用户可展开「用户详情」，展示该用户在各家谱中的角色信息（家谱名称 + 角色）

#### 2.3.2 用户角色修改

- 支持修改用户在指定家谱中的角色（升为管理员 / 降为普通用户）
- 支持批量处理（可选，后续迭代）
- 执行降级前需通过 2.2.2 中保护规则校验

#### 2.3.3 用户所属家谱查看

- 在用户详情中，以列表形式展示该用户加入的所有家谱及对应角色
- 支持直接跳转到对应家谱详情页

---

## 3. 家谱管理模块优化

### 3.1 家谱详情页——成员权限管理

**入口**：后台管理系统 → 家谱管理 → 查看家谱详情 → 成员列表

**新增操作**：在成员列表中，支持对每个成员执行：

- **设置为家谱管理员**：将该成员对应的用户账号提升为本家谱管理员
- **取消管理员权限**：将该成员对应的用户账号在本家谱的角色降为普通用户

**前置条件**：

- 该成员必须已关联用户账号（未注册用户无法设置权限）
- 取消操作需校验是否为唯一管理员（参考 2.2.2 保护规则）

**UI 建议**：在成员列表行尾增加「权限」操作列，使用下拉或 Tag 标签展示当前角色，点击可快速切换。

---

## 4. 成员管理模块优化

### 4.1 列表分页查询

支持以下条件组合筛选：

| 筛选条件 | 类型 | 说明 |
|----------|------|------|
| 姓名 | 模糊匹配 | 支持中文姓名部分匹配 |
| 性别 | 单选 | 男 / 女 / 未知 |
| 出生日期 | 日期范围 | 开始日期 ~ 结束日期 |
| 所属家谱 | 下拉单选 | 从数据库动态加载家谱列表 |
| 创建时间 | 日期时间范围 | 精确到天 |

- 分页默认每页 20 条，支持切换 10 / 20 / 50 条
- 筛选条件支持重置

### 4.2 成员列表展示字段

在现有字段基础上新增：

- **账号角色**：展示该成员关联用户在本家谱中的角色（家谱管理员 / 普通用户 / 未关联账号）

### 4.3 成员编辑功能增强

在编辑成员信息时，新增以下可编辑项：

- **所属家谱**：支持修改成员所属的家谱，家谱列表从数据库实时查询
- **家谱角色**：可同步修改该成员在所属家谱中的权限角色（需关联用户账号）

> **注意**：修改所属家谱涉及跨家谱数据迁移，需在操作前弹出二次确认弹窗，并说明影响范围。

---

## 5. 审批管理模块优化

### 5.1 审批列表信息完善

在现有列表基础上，新增以下展示字段：

| 字段 | 说明 |
|------|------|
| 申请成员姓名 | 申请加入家谱的成员姓名 |
| 申请成员所在家谱 | 该申请归属的家谱名称 |
| 申请时间 | 精确到秒 |
| 申请状态 | 待审批 / 已通过 / 已拒绝 |
| 审批人 | 执行审批操作的管理员信息 |
| 审批时间 | 审批操作的时间 |

### 5.2 列表分页查询

支持以下条件组合筛选：

| 筛选条件 | 类型 | 说明 |
|----------|------|------|
| 申请成员 | 模糊匹配 | 按成员姓名搜索 |
| 所在家谱 | 下拉单选 | 从数据库动态加载 |
| 申请时间 | 日期时间范围 | 精确到天 |
| 申请状态 | 多选 | 待审批 / 已通过 / 已拒绝 |

### 5.3 快捷跳转

- 点击「申请成员」姓名，跳转至成员管理页面，并自动定位到该成员的详情/编辑页
- 跳转时保留当前审批列表的筛选状态（回跳后不丢失）

---

## 6. 小程序家谱成员管理模块优化

### 6.1 成员关系树操作——新增上下代

**功能描述**：在小程序家谱树状图中，支持所有成员节点进行上下代成员的新增操作。

**操作入口**：点击任意成员节点 → 弹出操作菜单 → 选择「新增上一代」或「新增下一代」

#### 6.1.1 新增上一代（父辈）

- 在当前成员节点上方插入新成员
- 关系类型默认为"父亲"或"母亲"（可选择）
- 若当前成员已有父辈成员，需提示："已存在父辈成员，是否继续添加？"（适用于非亲生父母等特殊场景）

#### 6.1.2 新增下一代（子辈）

- 在当前成员节点下方插入新成员
- 关系类型默认为"儿子"或"女儿"（可选择）

### 6.2 新增成员信息字段

小程序新增成员表单字段与后台管理系统保持一致，包含但不限于：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 姓名 | 文本 | 是 | |
| 性别 | 单选 | 是 | 男 / 女 |
| 出生日期 | 日期选择 | 否 | |
| 出生地 | 文本 | 否 | |
| 去世日期 | 日期选择 | 否 | 若填写则展示已故标识 |
| 简介/备注 | 多行文本 | 否 | 字数限制 500 字 |
| 头像 | 图片上传 | 否 | 支持从相册选择或拍照 |
| 与关联成员的关系 | 单选 | 是 | 根据新增方向自动预填 |

### 6.3 审批流程（小程序端）

- 普通用户在小程序端新增成员后，数据进入**待审批**状态，需由家谱管理员审批通过后方可正式录入
- 家谱管理员新增成员时，可选择直接录入（免审批）或提交审批
- 审批通过/拒绝后，申请用户收到小程序消息通知

---

## 7. 数据模型变更说明

### 7.1 用户表（User）新增/调整字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| global_role | enum | 全局角色：SUPER_ADMIN / GENEALOGY_ADMIN / NORMAL_USER |

### 7.2 用户-家谱关联表（UserGenealogy）

记录用户在每个家谱中的具体角色，实现多家谱角色隔离。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键 |
| user_id | bigint | 用户 ID |
| genealogy_id | bigint | 家谱 ID |
| role | enum | ADMIN / MEMBER |
| joined_at | datetime | 加入时间 |
| created_by | bigint | 操作人 ID |

### 7.3 成员表（Member）关联增强

| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | bigint | 关联用户 ID，可为 NULL（表示未注册用户） |

---

## 8. 权限矩阵

| 功能操作 | 超级管理员 | 家谱管理员 | 普通用户 |
|----------|:----------:|:----------:|:--------:|
| 登录后台管理系统 | ✅ | ❌ | ❌ |
| 查看所有家谱 | ✅ | ❌ | ❌ |
| 修改任意家谱信息 | ✅ | ❌ | ❌ |
| 查看所有用户 | ✅ | ❌ | ❌ |
| 修改用户角色 | ✅ | ❌ | ❌ |
| 管理自己的家谱（小程序） | ✅ | ✅ | ❌ |
| 邀请用户为家谱管理员 | ✅ | ✅（限本家谱） | ❌ |
| 审批成员申请 | ✅ | ✅（限本家谱） | ❌ |
| 新增成员（免审批） | ✅ | ✅（限本家谱） | ❌ |
| 新增成员（需审批） | ✅ | ✅ | ✅ |
| 查看家谱成员树 | ✅ | ✅ | ✅ |

---

## 11. 安全性优化

### 11.1 认证机制升级

| 优化项 | 当前状态 | 目标状态 | 优先级 |
|--------|----------|----------|--------|
| 认证方式 | X-User-Id Header | JWT Token 认证 | 高 |
| 密码存储 | 明文存储 | BCrypt 加密 | 高 |
| Token 管理 | 无 | 支持 Token 刷新、失效机制 | 高 |
| 登录保护 | 无 | 登录失败次数限制、验证码 | 中 |

### 11.2 权限控制增强

- 实现基于角色的访问控制（RBAC）
- 添加接口级权限注解 `@RequiresRole`
- 完善数据权限：用户只能操作自己有权限的家谱数据
- 添加操作日志审计

### 11.3 接口安全

- 添加请求频率限制（Rate Limiting）
- 敏感操作二次验证（如删除家谱）
- XSS/CSRF 防护

---

## 12. 功能补充优化

### 12.1 关系类型完善

当前关系类型不完整，需补充：

| 现有类型 | 缺失类型 |
|----------|----------|
| father_son | father_daughter |
| mother_son | mother_daughter |

新增关系类型：

| 关系类型 | 说明 |
|----------|------|
| spouse | 配偶 |
| sibling | 兄弟姐妹 |

### 12.2 成员信息修改

`EditRequest` 处理中缺少 `birthDate` 字段的处理逻辑，需补充。

### 12.3 文件上传功能

- 实现头像上传功能
- 支持本地存储或 OSS 云存储
- 图片压缩和格式校验
- 上传进度展示

### 12.4 扫码加入家谱

小程序端新增功能：

- 生成家谱二维码
- 扫描二维码加入家谱
- 二维码有效期设置

### 12.5 消息通知系统

| 通知场景 | 通知方式 |
|----------|----------|
| 审批通过/拒绝 | 小程序消息 + 站内信 |
| 新成员加入 | 站内信 |
| 家谱邀请 | 小程序消息 |
| 系统公告 | 站内信 |

### 12.6 搜索功能

- 家谱名称搜索
- 成员姓名搜索
- 组合条件搜索

---

## 13. 代码质量优化

### 13.1 单元测试

- Controller 层接口测试
- Service 层业务逻辑测试
- 测试覆盖率目标：60%+

### 13.2 异常处理

- 定义统一业务异常码
- 完善异常信息国际化
- 前端友好的错误提示

### 13.3 日志系统

| 日志类型 | 说明 |
|----------|------|
| 操作日志 | 记录关键业务操作 |
| 错误日志 | 异常堆栈记录 |
| 访问日志 | API 请求记录 |

### 13.4 配置管理

- 移除硬编码配置
- 使用环境变量或配置中心
- 区分开发/测试/生产环境配置

---

## 14. 架构优化

### 14.1 缓存机制

| 缓存场景 | 缓存策略 |
|----------|----------|
| 用户信息 | Redis，过期时间 30 分钟 |
| 家谱树结构 | Redis，变更时清除 |
| 系统配置 | Redis，长期缓存 |

### 14.2 事务管理

- 复杂业务操作添加 `@Transactional`
- 明确事务边界
- 处理分布式事务场景（如有）

### 14.3 前端架构

**管理后台优化：**

- 引入 Pinia 状态管理
- API 接口层统一封装
- 组件库按需加载优化

**小程序优化：**

- 升级为 Vue 3 Composition API
- TypeScript 支持
- 组件化重构

### 14.4 API 文档

- 集成 Swagger/Knife4j
- 自动生成 API 文档
- 接口调试支持

---

## 15. 性能优化

### 15.1 数据库优化

- 添加必要索引（家谱码、用户ID、家谱ID）
- 分页查询优化
- 慢查询监控

### 15.2 前端性能

- 路由懒加载
- 图片懒加载
- 列表虚拟滚动（大数据量）
- 打包体积优化

### 15.3 接口性能

- 接口响应时间监控
- 批量接口合并
- 数据传输压缩

---

## 16. 用户体验优化

### 16.1 小程序体验

| 优化项 | 说明 |
|--------|------|
| 加载状态 | 统一 loading 组件 |
| 空状态 | 无数据时的友好提示 |
| 错误提示 | 操作失败的明确反馈 |
| 下拉刷新 | 列表页支持下拉刷新 |
| 骨架屏 | 首屏加载骨架屏 |

### 16.2 管理后台体验

| 优化项 | 说明 |
|--------|------|
| 面包屑导航 | 页面层级展示 |
| 操作确认 | 删除等危险操作二次确认 |
| 批量操作 | 支持批量删除、批量审批 |
| 数据导出 | 成员数据导出 Excel |

### 16.3 交互细节

- 家谱树节点拖拽排序
- 成员详情卡片快速编辑
- 操作历史记录查看
- 数据变更对比展示

---

## 17. 优化优先级排期

### 第一阶段（P0 - 安全加固）

| 优化项 | 预计工时 |
|--------|----------|
| JWT 认证实现 | 2 天 |
| 密码加密存储 | 0.5 天 |
| 权限控制完善 | 2 天 |
| 接口安全加固 | 1 天 |

### 第二阶段（P1 - 功能完善）

| 优化项 | 预计工时 |
|--------|----------|
| 关系类型补充 | 0.5 天 |
| 成员信息修改完善 | 0.5 天 |
| 文件上传功能 | 2 天 |
| 扫码加入家谱 | 1 天 |
| 搜索功能 | 1 天 |

### 第三阶段（P2 - 质量提升）

| 优化项 | 预计工时 |
|--------|----------|
| 单元测试编写 | 3 天 |
| 异常处理完善 | 1 天 |
| 日志系统搭建 | 1 天 |
| API 文档集成 | 0.5 天 |

### 第四阶段（P3 - 体验优化）

| 优化项 | 预计工时 |
|--------|----------|
| 消息通知系统 | 2 天 |
| 缓存机制 | 1 天 |
| 前端性能优化 | 2 天 |
| 用户体验细节 | 2 天 |

---

> **变更记录**
>
> | 版本 | 日期 | 修改内容 | 修改人 |
> |------|------|----------|--------|
> | v1.0.1 | 2026-02-21 | 初稿，整理 v1.0 优化需求 | PM |
> | v1.0.2 | 2026-02-21 | 新增安全性、功能补充、代码质量、架构、性能、用户体验优化章节 | PM |
