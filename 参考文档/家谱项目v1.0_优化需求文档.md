# 家谱项目 v1.0 功能优化需求文档

**文档版本**：v1.0.1
**创建日期**：2026-02-21
**文档状态**：待评审
**产品负责人**：待定
**适用范围**：后台管理系统 & 微信小程序端

---

## 目录

1. [背景与目标](#1-背景与目标)
2. [用户角色模块优化](#2-用户角色模块优化)
3. [家谱管理模块优化](#3-家谱管理模块优化)
4. [成员管理模块优化](#4-成员管理模块优化)
5. [审批管理模块优化](#5-审批管理模块优化)
6. [小程序家谱成员管理模块优化](#6-小程序家谱成员管理模块优化)
7. [数据模型变更说明](#7-数据模型变更说明)
8. [权限矩阵](#8-权限矩阵)
9. [非功能性需求](#9-非功能性需求)
10. [开放问题与风险](#10-开放问题与风险)

---

## 1. 背景与目标

### 1.1 背景

当前家谱项目 v1.0 已完成基础功能搭建，但在用户权限体系、数据管理操作易用性等方面存在较多待完善点，影响管理员日常操作效率及用户体验。

### 1.2 优化目标

- 建立清晰的三层用户角色体系，明确各角色权限边界
- 提升后台管理系统的数据查询与操作效率
- 完善审批流程的信息可见性
- 增强小程序端成员树状管理能力

### 1.3 术语定义

| 术语 | 说明 |
|------|------|
| 超级管理员 | 平台最高权限账号，可管理所有家谱及用户 |
| 家谱管理员 | 拥有一个或多个家谱管理权的用户 |
| 普通用户 | 仅能查看所在家谱信息的基础用户 |
| 成员 | 家谱中录入的人员信息，与"用户"账号为不同概念 |
| 用户-成员关联 | 同一自然人在系统中同时拥有"用户账号"与"家谱成员身份" |

---

## 2. 用户角色模块优化

### 2.1 角色体系设计

系统设置三种用户角色，各角色职责与权限严格隔离：

| 角色 | 归属范围 | 访问入口 | 核心职责 |
|------|----------|----------|----------|
| 超级管理员 | 平台级，不属于任何家谱 | 后台管理系统 | 管理所有家谱、用户、成员信息 |
| 家谱管理员 | 一个或多个家谱 | 微信小程序「我的家谱」 | 管理所辖家谱及其成员 |
| 普通用户 | 所属家谱（只读） | 微信小程序 | 查看家谱信息，申请操作需审批 |

> **设计说明**：用户角色为"全局最高角色取值"——只要用户在任意一个家谱担任家谱管理员，其账号角色即标记为"家谱管理员"；当其在所有家谱均不再担任管理员时，自动降级为普通用户。

### 2.2 角色获取与变更规则

#### 2.2.1 家谱管理员的产生方式

- **创建家谱时**：创建家谱的第一个用户自动成为该家谱的家谱管理员
- **管理员邀请**：家谱管理员可在小程序内将普通用户设置为本家谱的共同管理员
- **超级管理员操作**：超级管理员可在后台直接修改某用户在指定家谱中的角色

#### 2.2.2 角色降级保护规则

- 超级管理员将某用户设置为普通用户时，该用户将失去**所有家谱**的管理权限
- **保护机制**：若目标用户是某一家谱的**唯一管理员**，则禁止执行降级操作，系统需给出提示：
  > "该用户是「{家谱名称}」的唯一管理员，请先为该家谱指定其他管理员后再操作。"
- 若用户同时管理多个家谱，降级后所有家谱管理权一并撤销

#### 2.2.3 用户与成员的关系说明

- 用户（User）与成员（Member）是两个独立的数据实体
- 一个用户可以是多个家谱中的成员
- 用户在某一家谱中的角色（管理员/普通用户）与其成员身份相互独立，需分别维护

### 2.3 超级管理员——用户管理功能

#### 2.3.1 用户列表

- 支持按角色（家谱管理员 / 普通用户）筛选
- 列表展示字段：用户昵称、手机号/OpenID、账号角色、所属家谱数量、注册时间、最后登录时间
- 点击用户可展开「用户详情」，展示该用户在各家谱中的角色信息（家谱名称 + 角色）

#### 2.3.2 用户角色修改

- 支持修改用户在指定家谱中的角色（升为管理员 / 降为普通用户）
- 支持批量处理（可选，后续迭代）
- 执行降级前需通过 2.2.2 中保护规则校验

#### 2.3.3 用户所属家谱查看

- 在用户详情中，以列表形式展示该用户加入的所有家谱及对应角色
- 支持直接跳转到对应家谱详情页

---

## 3. 家谱管理模块优化

### 3.1 家谱详情页——成员权限管理

**入口**：后台管理系统 → 家谱管理 → 查看家谱详情 → 成员列表

**新增操作**：在成员列表中，支持对每个成员执行：

- **设置为家谱管理员**：将该成员对应的用户账号提升为本家谱管理员
- **取消管理员权限**：将该成员对应的用户账号在本家谱的角色降为普通用户

**前置条件**：

- 该成员必须已关联用户账号（未注册用户无法设置权限）
- 取消操作需校验是否为唯一管理员（参考 2.2.2 保护规则）

**UI 建议**：在成员列表行尾增加「权限」操作列，使用下拉或 Tag 标签展示当前角色，点击可快速切换。

---

## 4. 成员管理模块优化

### 4.1 列表分页查询

支持以下条件组合筛选：

| 筛选条件 | 类型 | 说明 |
|----------|------|------|
| 姓名 | 模糊匹配 | 支持中文姓名部分匹配 |
| 性别 | 单选 | 男 / 女 / 未知 |
| 出生日期 | 日期范围 | 开始日期 ~ 结束日期 |
| 所属家谱 | 下拉单选 | 从数据库动态加载家谱列表 |
| 创建时间 | 日期时间范围 | 精确到天 |

- 分页默认每页 20 条，支持切换 10 / 20 / 50 条
- 筛选条件支持重置

### 4.2 成员列表展示字段

在现有字段基础上新增：

- **账号角色**：展示该成员关联用户在本家谱中的角色（家谱管理员 / 普通用户 / 未关联账号）

### 4.3 成员编辑功能增强

在编辑成员信息时，新增以下可编辑项：

- **所属家谱**：支持修改成员所属的家谱，家谱列表从数据库实时查询
- **家谱角色**：可同步修改该成员在所属家谱中的权限角色（需关联用户账号）

> **注意**：修改所属家谱涉及跨家谱数据迁移，需在操作前弹出二次确认弹窗，并说明影响范围。

---

## 5. 审批管理模块优化

### 5.1 审批列表信息完善

在现有列表基础上，新增以下展示字段：

| 字段 | 说明 |
|------|------|
| 申请成员姓名 | 申请加入家谱的成员姓名 |
| 申请成员所在家谱 | 该申请归属的家谱名称 |
| 申请时间 | 精确到秒 |
| 申请状态 | 待审批 / 已通过 / 已拒绝 |
| 审批人 | 执行审批操作的管理员信息 |
| 审批时间 | 审批操作的时间 |

### 5.2 列表分页查询

支持以下条件组合筛选：

| 筛选条件 | 类型 | 说明 |
|----------|------|------|
| 申请成员 | 模糊匹配 | 按成员姓名搜索 |
| 所在家谱 | 下拉单选 | 从数据库动态加载 |
| 申请时间 | 日期时间范围 | 精确到天 |
| 申请状态 | 多选 | 待审批 / 已通过 / 已拒绝 |

### 5.3 快捷跳转

- 点击「申请成员」姓名，跳转至成员管理页面，并自动定位到该成员的详情/编辑页
- 跳转时保留当前审批列表的筛选状态（回跳后不丢失）

---

## 6. 小程序家谱成员管理模块优化

### 6.1 成员关系树操作——新增上下代

**功能描述**：在小程序家谱树状图中，支持所有成员节点进行上下代成员的新增操作。

**操作入口**：点击任意成员节点 → 弹出操作菜单 → 选择「新增上一代」或「新增下一代」

#### 6.1.1 新增上一代（父辈）

- 在当前成员节点上方插入新成员
- 关系类型默认为"父亲"或"母亲"（可选择）
- 若当前成员已有父辈成员，需提示："已存在父辈成员，是否继续添加？"（适用于非亲生父母等特殊场景）

#### 6.1.2 新增下一代（子辈）

- 在当前成员节点下方插入新成员
- 关系类型默认为"儿子"或"女儿"（可选择）

### 6.2 新增成员信息字段

小程序新增成员表单字段与后台管理系统保持一致，包含但不限于：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 姓名 | 文本 | 是 | |
| 性别 | 单选 | 是 | 男 / 女 |
| 出生日期 | 日期选择 | 否 | |
| 出生地 | 文本 | 否 | |
| 去世日期 | 日期选择 | 否 | 若填写则展示已故标识 |
| 简介/备注 | 多行文本 | 否 | 字数限制 500 字 |
| 头像 | 图片上传 | 否 | 支持从相册选择或拍照 |
| 与关联成员的关系 | 单选 | 是 | 根据新增方向自动预填 |

### 6.3 审批流程（小程序端）

- 普通用户在小程序端新增成员后，数据进入**待审批**状态，需由家谱管理员审批通过后方可正式录入
- 家谱管理员新增成员时，可选择直接录入（免审批）或提交审批
- 审批通过/拒绝后，申请用户收到小程序消息通知

---

## 7. 数据模型变更说明

### 7.1 用户表（User）新增/调整字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| global_role | enum | 全局角色：SUPER_ADMIN / GENEALOGY_ADMIN / NORMAL_USER |

### 7.2 用户-家谱关联表（UserGenealogy）

记录用户在每个家谱中的具体角色，实现多家谱角色隔离。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键 |
| user_id | bigint | 用户 ID |
| genealogy_id | bigint | 家谱 ID |
| role | enum | ADMIN / MEMBER |
| joined_at | datetime | 加入时间 |
| created_by | bigint | 操作人 ID |

### 7.3 成员表（Member）关联增强

| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | bigint | 关联用户 ID，可为 NULL（表示未注册用户） |

---

## 8. 权限矩阵

| 功能操作 | 超级管理员 | 家谱管理员 | 普通用户 |
|----------|:----------:|:----------:|:--------:|
| 登录后台管理系统 | ✅ | ❌ | ❌ |
| 查看所有家谱 | ✅ | ❌ | ❌ |
| 修改任意家谱信息 | ✅ | ❌ | ❌ |
| 查看所有用户 | ✅ | ❌ | ❌ |
| 修改用户角色 | ✅ | ❌ | ❌ |
| 管理自己的家谱（小程序） | ✅ | ✅ | ❌ |
| 邀请用户为家谱管理员 | ✅ | ✅（限本家谱） | ❌ |
| 审批成员申请 | ✅ | ✅（限本家谱） | ❌ |
| 新增成员（免审批） | ✅ | ✅（限本家谱） | ❌ |
| 新增成员（需审批） | ✅ | ✅ | ✅ |
| 查看家谱成员树 | ✅ | ✅ | ✅ |

---

## 9. 非功能性需求

### 9.1 数据一致性

- 角色变更操作需在事务中执行，确保 UserGenealogy 表与 User 全局角色字段同步更新
- 唯一管理员保护校验需在数据库层加锁，防止并发操作绕过校验

### 9.2 操作日志

- 所有角色变更、成员编辑、审批操作均需记录操作日志（操作人、操作时间、操作内容、变更前后值）

### 9.3 性能要求

- 后台列表分页查询响应时间 < 1s（数据量 10 万级）
- 成员树状图加载时间 < 2s（单家谱成员数 < 1000 人）

---

## 10. 开放问题与风险

| # | 问题描述 | 优先级 | 负责人 | 状态 |
|---|----------|--------|--------|------|
| 1 | 小程序端普通用户新增成员是否需要审批，审批节点如何设计？ | 高 | 产品 | 待讨论 |
| 2 | 家谱管理员被降级后，其历史审批记录如何展示？ | 中 | 产品/研发 | 待讨论 |
| 3 | 成员跨家谱迁移时，原家谱中的成员关系数据是否保留？ | 高 | 研发 | 待讨论 |
| 4 | 超级管理员账号是否支持多个？如何创建超级管理员？ | 高 | 产品 | 待讨论 |
| 5 | 小程序新增上一代时，若成员已存在父辈，是否允许添加多个父辈节点（如养父母）？ | 中 | 产品 | 待讨论 |

---

*文档结束*

> **变更记录**
>
> | 版本 | 日期 | 修改内容 | 修改人 |
> |------|------|----------|--------|
> | v1.0.1 | 2026-02-21 | 初稿，整理 v1.0 优化需求 | PM |
