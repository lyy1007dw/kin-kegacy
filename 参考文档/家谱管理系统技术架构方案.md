# 家谱管理系统技术架构方案

## 一、项目概述

### 1.1 项目背景

该系统分三端：
1. **后端服务**：SpringBoot 3
2. **管理后台**：Vue 3 + TypeScript + Naive UI
3. **小程序端**：uni-app，适配微信小程序

### 1.2 核心功能模块

- **用户系统**：微信授权登录（小程序）/ 账号密码登录（管理后台）
- **家谱管理**：创建家谱、加入家谱（6位家谱码）、家谱基本信息维护
- **成员管理**：成员档案（姓名、性别、头像、出生日期、简介）、成员关系维护（父子、夫妻等）
- **族谱树**：可视化树形展示，支持点击查看成员详情
- **审批流程**：成员申请加入审批、成员信息修改申请审批
- **消息通知**：审批消息、系统通知
- **我的**：个人信息管理、家谱码分享、退出等

### 1.3 技术栈

| 端 | 技术栈 |
|----|--------|
| 后端 | Spring Boot 3, MyBatis-Plus, MySQL 8, Redis |
| 小程序 | uni-app, Vue 3, TypeScript |
| 管理后台 | Vue 3, TypeScript, Naive UI, Pinia |
| 其他 | Nginx, Docker |

---

## 二、整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                           小程序端 (uni-app)                      │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │  首页   │ │ 家谱树  │ │ 审批中心 │ │  我的   │ │ 弹窗/表单 │  │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘  │
└───────┼──────────┼──────────┼──────────┼──────────┼────────────┘
        │          │          │          │          │
        └──────────┴──────────┴──────────┴──────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 网关 / Nginx                           │
│                  (路由、负载均衡、静态资源)                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    后端服务 (Spring Boot 3)                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │ 用户模块    │ │ 家谱模块    │ │ 成员模块    │ │ 审批模块  │ │
│  │ UserService │ │FamilyService│ │MemberService│ │ApprovalSvc│ │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └─────┬─────┘ │
│         │              │              │              │        │
│         └──────────────┴──────────────┴──────────────┘        │
│                              │                                   │
│                    ┌─────────▼─────────┐                         │
│                    │   公共模块        │                         │
│                    │(异常处理/日志/工具) │                         │
│                    └─────────┬─────────┘                         │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    管理后台 (Vue3 + TS + Naive UI)               │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │ 仪表盘  │ │ 家谱管理 │ │ 成员管理 │ │ 审批管理 │ │ 系统管理 │ │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据库 (MySQL 8)                            │
│   user │ family │ family_member │ member_relation │ request    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、数据库核心表设计

### 3.1 建表SQL

```sql
-- =============================================
-- 家谱管理系统 - 核心数据库表设计
-- =============================================

-- ----------------------------
-- 1. 用户表
-- ----------------------------
CREATE TABLE `user` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `openid` VARCHAR(64) COMMENT '微信openid(小程序用户)',
    `username` VARCHAR(64) COMMENT '用户名(管理后台)',
    `password_hash` VARCHAR(128) COMMENT '密码哈希',
    `nickname` VARCHAR(64) COMMENT '昵称',
    `avatar` VARCHAR(512) COMMENT '头像URL',
    `phone` VARCHAR(20) COMMENT '手机号',
    `role` TINYINT NOT NULL DEFAULT 0 COMMENT '角色: 0-普通用户 1-管理员',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-禁用 1-正常',
    `last_login_time` DATETIME COMMENT '最后登录时间',
    `last_login_ip` VARCHAR(45) COMMENT '最后登录IP',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_openid` (`openid`),
    UNIQUE KEY `uk_username` (`username`),
    KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- ----------------------------
-- 2. 家谱表
-- ----------------------------
CREATE TABLE `family` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '家谱ID',
    `name` VARCHAR(128) NOT NULL COMMENT '家谱名称',
    `code` VARCHAR(6) NOT NULL COMMENT '6位家谱码',
    `description` TEXT COMMENT '家谱简介',
    `avatar` VARCHAR(512) COMMENT '家谱头像',
    `creator_id` BIGINT NOT NULL COMMENT '创建者用户ID',
    `member_count` INT NOT NULL DEFAULT 1 COMMENT '成员数量',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-禁用 1-正常',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_code` (`code`),
    KEY `idx_creator_id` (`creator_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='家谱表';

-- ----------------------------
-- 3. 家谱成员表
-- ----------------------------
CREATE TABLE `family_member` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '成员ID',
    `family_id` BIGINT NOT NULL COMMENT '家谱ID',
    `user_id` BIGINT COMMENT '关联用户ID(可为空,未注册用户)',
    `name` VARCHAR(64) NOT NULL COMMENT '姓名',
    `gender` TINYINT NOT NULL COMMENT '性别: 1-男 2-女 0-未知',
    `avatar` VARCHAR(512) COMMENT '头像URL',
    `birth_date` DATE COMMENT '出生日期',
    `birth_place` VARCHAR(256) COMMENT '出生地',
    `bio` TEXT COMMENT '个人简介',
    `parent_id` BIGINT COMMENT '父亲ID',
    `is_creator` TINYINT NOT NULL DEFAULT 0 COMMENT '是否创建者: 0-否 1-是',
    `is_verified` TINYINT NOT NULL DEFAULT 0 COMMENT '是否认证: 0-否 1-是',
    `position_x` INT COMMENT '族谱树X坐标',
    `position_y` INT COMMENT '族谱树Y坐标',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    KEY `idx_family_id` (`family_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='家谱成员表';

-- ----------------------------
-- 4. 成员关系表
-- ----------------------------
CREATE TABLE `member_relation` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '关系ID',
    `family_id` BIGINT NOT NULL COMMENT '家谱ID',
    `member_id` BIGINT NOT NULL COMMENT '成员ID',
    `relative_id` BIGINT NOT NULL COMMENT '关联成员ID',
    `relation_type` VARCHAR(32) NOT NULL COMMENT '关系类型:父子/母女/夫妻/兄弟姐妹等',
    `relation_desc` VARCHAR(64) COMMENT '关系描述',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    KEY `idx_family_id` (`family_id`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_relative_id` (`relative_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='成员关系表';

-- ----------------------------
-- 5. 加入申请表
-- ----------------------------
CREATE TABLE `join_request` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '申请ID',
    `family_id` BIGINT NOT NULL COMMENT '家谱ID',
    `applicant_id` BIGINT NOT NULL COMMENT '申请人用户ID',
    `applicant_name` VARCHAR(64) NOT NULL COMMENT '申请人姓名',
    `target_member_id` BIGINT COMMENT '申请加入的目标成员ID(父亲/母亲)',
    `relation_desc` VARCHAR(64) COMMENT '与目标成员的关系描述',
    `apply_reason` VARCHAR(256) COMMENT '申请理由',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0-待审批 1-已同意 2-已拒绝 3-已取消',
    `reviewer_id` BIGINT COMMENT '审批人ID',
    `review_time` DATETIME COMMENT '审批时间',
    `review_remark` VARCHAR(256) COMMENT '审批备注',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    KEY `idx_family_id` (`family_id`),
    KEY `idx_applicant_id` (`applicant_id`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='加入申请表';

-- ----------------------------
-- 6. 信息修改申请表
-- ----------------------------
CREATE TABLE `edit_request` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '申请ID',
    `family_id` BIGINT NOT NULL COMMENT '家谱ID',
    `member_id` BIGINT NOT NULL COMMENT '被修改的成员ID',
    `applicant_id` BIGINT NOT NULL COMMENT '申请人ID',
    `field_name` VARCHAR(32) NOT NULL COMMENT '修改字段',
    `old_value` TEXT COMMENT '原值',
    `new_value` TEXT COMMENT '新值',
    `apply_reason` VARCHAR(256) COMMENT '申请理由',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0-待审批 1-已同意 2-已拒绝 3-已取消',
    `reviewer_id` BIGINT COMMENT '审批人ID',
    `review_time` DATETIME COMMENT '审批时间',
    `review_remark` VARCHAR(256) COMMENT '审批备注',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    KEY `idx_family_id` (`family_id`),
    KEY `idx_member_id` (`member_id`),
    KEY `idx_applicant_id` (`applicant_id`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='信息修改申请表';

-- ----------------------------
-- 7. 消息通知表
-- ----------------------------
CREATE TABLE `notification` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '通知ID',
    `user_id` BIGINT NOT NULL COMMENT '接收用户ID',
    `type` VARCHAR(32) NOT NULL COMMENT '通知类型: join_approval/edit_approval/system',
    `title` VARCHAR(128) NOT NULL COMMENT '通知标题',
    `content` TEXT COMMENT '通知内容',
    `related_id` BIGINT COMMENT '关联ID(申请ID等)',
    `is_read` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已读: 0-否 1-是',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_is_read` (`is_read`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='消息通知表';

-- ----------------------------
-- 8. 用户-家谱关联表(多对多)
-- ----------------------------
CREATE TABLE `user_family` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `family_id` BIGINT NOT NULL COMMENT '家谱ID',
    `role` TINYINT NOT NULL DEFAULT 0 COMMENT '角色: 0-普通成员 1-创建者 2-管理员',
    `join_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_family` (`user_id`, `family_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_family_id` (`family_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户-家谱关联表';
```

### 3.2 表关系说明

```
┌─────────┐       ┌──────────────┐       ┌───────────────┐
│  user   │──────>│  user_family │<──────│    family     │
└─────────┘       └──────────────┘       └───────┬───────┘
                                                 │
                                                 v
                                        ┌───────────────┐
                                        │family_member  │
                                        └───────┬───────┘
                                                │
                                                v
                                        ┌───────────────┐
                                        │member_relation│
                                        └───────────────┘

┌─────────────┐       ┌─────────────┐
│join_request │       │edit_request │
└──────┬──────┘       └──────┬──────┘
       │                     │
       v                     v
┌─────────────┐       ┌─────────────┐
│notification │       │notification │
└─────────────┘       └─────────────┘
```

---

## 四、后端项目模块划分

### 4.1 项目结构

```
family-tree-server/
├── family-tree-common/              # 公共模块
│   ├── common-core/                 # 核心工具类
│   │   ├── annotation/            # 自定义注解
│   │   ├── constant/               # 常量定义
│   │   ├── exception/              # 全局异常处理
│   │   ├── result/                 # 统一返回结果
│   │   └── util/                   # 工具类
│   ├── common-redis/                # Redis配置
│   ├── common-security/            # 安全认证配置
│   └── common-swagger/              # Swagger配置
│
├── family-tree-api/                 # API模块(对外接口)
│   ├── controller/                  # 控制器
│   │   ├── MiniProgramController/   # 小程序接口
│   │   ├── AdminController/         # 管理后台接口
│   │   └── common/                  # 公共接口
│   └── dto/                         # 数据传输对象
│
├── family-tree-biz/                 # 业务模块
│   ├── user/                        # 用户模块
│   │   ├── controller/
│   │   ├── service/
│   │   ├── mapper/
│   │   └── entity/
│   ├── family/                      # 家谱模块
│   │   ├── controller/
│   │   ├── service/
│   │   ├── mapper/
│   │   └── entity/
│   ├── member/                      # 成员模块
│   ├── approval/                   # 审批模块
│   └── notification/               # 通知模块
│
└── family-tree-admin/              # 管理后台模块(独立部署时)
    ├── controller/
    ├── service/
    └── security/
```

### 4.2 模块职责

| 模块 | 职责 |
|------|------|
| common-core | 提供基础工具类、异常处理、统一响应等 |
| common-redis | Redis配置、缓存、分布式锁 |
| common-security | JWT、权限认证、登录验证 |
| common-swagger | API文档生成 |
| user | 用户注册、登录、信息管理 |
| family | 家谱CRUD、家谱码管理 |
| member | 成员管理、关系维护 |
| approval | 加入申请、修改申请、审批流程 |
| notification | 消息推送、通知管理 |

---

## 五、前后端接口风格约定

### 5.1 RESTful API 设计

#### 认证接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/auth/login | 账号密码登录 |
| POST | /api/auth/wx-login | 微信授权登录 |
| POST | /api/auth/logout | 退出登录 |
| GET | /api/auth/info | 获取当前用户信息 |

#### 家谱接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/family | 获取我的家谱列表 |
| POST | /api/family | 创建家谱 |
| GET | /api/family/{id} | 获取家谱详情 |
| PUT | /api/family/{id} | 更新家谱信息 |
| DELETE | /api/family/{id} | 删除家谱 |
| GET | /api/family/code/{code} | 通过家谱码查找家谱 |
| POST | /api/family/{id}/join | 申请加入家谱 |

#### 成员接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/family/{id}/member | 获取成员列表 |
| GET | /api/member/{id} | 获取成员详情 |
| POST | /api/member | 添加成员 |
| PUT | /api/member/{id} | 更新成员信息 |
| DELETE | /api/member/{id} | 删除成员 |
| GET | /api/member/{id}/relation | 获取成员关系 |

#### 审批接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/approval/pending | 获取待审批列表 |
| GET | /api/approval/history | 获取审批历史 |
| POST | /api/approval/{id}/approve | 审批同意 |
| POST | /api/approval/{id}/reject | 审批拒绝 |
| POST | /api/approval/{id}/cancel | 取消申请 |

#### 通知接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/notification | 获取通知列表 |
| PUT | /api/notification/read/{id} | 标记已读 |
| PUT | /api/notification/read-all | 全部标记已读 |
| GET | /api/notification/unread-count | 未读数量 |

### 5.2 统一响应格式

#### 成功响应

```json
{
    "code": 200,
    "message": "success",
    "data": {
        // 业务数据
    },
    "timestamp": 1708400000000
}
```

#### 分页响应

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "records": [],
        "total": 100,
        "page": 1,
        "size": 10
    },
    "timestamp": 1708400000000
}
```

#### 错误响应

```json
{
    "code": 400,
    "message": "参数错误",
    "data": null,
    "timestamp": 1708400000000
}
```

### 5.3 HTTP 状态码规范

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 204 | 删除成功 |
| 400 | 参数错误 |
| 401 | 未授权（需要登录） |
| 403 | 禁止访问（权限不足） |
| 404 | 资源不存在 |
| 409 | 资源冲突 |
| 500 | 服务器内部错误 |

### 5.4 请求头规范

```
Content-Type: application/json
Authorization: Bearer <token>
X-Request-ID: uuid(请求追踪ID)
X-Source: miniprogram | admin | web
```

### 5.5 错误码规范（业务错误）

| 错误码 | 说明 |
|--------|------|
| 1000 | 用户不存在 |
| 1001 | 密码错误 |
| 1002 | 用户已被禁用 |
| 2000 | 家谱不存在 |
| 2001 | 家谱码无效 |
| 2002 | 已是家谱成员 |
| 3000 | 成员不存在 |
| 3001 | 成员已存在 |
| 4000 | 申请不存在 |
| 4001 | 申请已被处理 |
| 4002 | 无审批权限 |
| 5000 | 系统繁忙 |

---

## 六、安全设计

### 6.1 认证方式

- **小程序**：微信授权登录，获取 openid 生成 JWT
- **管理后台**：用户名密码登录，MD5/SHA256 加密

### 6.2 权限控制

- 基于 RBAC 权限模型
- 接口级权限注解
- 数据级权限（成员只能操作自己加入的家谱）

### 6.3 安全措施

- 请求参数签名验签
- 接口限流防刷
- SQL 注入防护
- XSS 攻击防护
- CORS 跨域配置

---

## 七、部署架构

```
                    ┌──────────────────┐
                    │     CDN/Nginx    │
                    │   (静态资源)     │
                    └────────┬─────────┘
                             │
                    ┌────────▼─────────┐
                    │   Nginx Gateway  │
                    │  (负载均衡/路由)  │
                    └────────┬─────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
    ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
    │  SpringBoot │   │  SpringBoot │   │  SpringBoot │
    │   Instance  │   │   Instance  │   │   Instance  │
    └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
           │                 │                 │
           └─────────────────┼─────────────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
        ┌─────▼─────┐  ┌─────▼─────┐  ┌─────▼─────┐
        │  MySQL    │  │   Redis   │  │   OSS/    │
        │  Master   │  │  Cluster  │  │  COS      │
        └───────────┘  └───────────┘  └───────────┘
```

---

## 八、开发规范

### 8.1 代码规范

- 命名规范：驼峰命名
- Controller 层：负责请求接收、参数校验、返回结果
- Service 层：负责业务逻辑处理
- Mapper 层：负责数据库操作
- Entity 层：负责数据实体

### 8.2 Git 提交规范

```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 代码重构
test: 测试用例
chore: 构建/依赖更新
```

### 8.3 日志规范

- INFO：正常业务日志
- WARN：警告日志
- ERROR：错误日志
- 关键操作需要记录操作日志

---

## 九、版本记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0.0 | 2026-02-20 | 初始版本 |

---

## 十、附录

### 10.1 技术选型理由

| 技术 | 选型理由 |
|------|----------|
| Spring Boot 3 | 最新LTS版本，生态完善，性能优异 |
| MySQL 8 | 支持JSON、全文索引等新特性 |
| Redis | 缓存、Session、分布式锁 |
| uni-app | 跨平台开发，支持微信小程序 |
| Vue 3 | 性能提升，Composition API |
| Naive UI | 组件丰富，TypeScript友好 |

### 10.2 参考文档

- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)
- [Vue 3 官方文档](https://vuejs.org/)
- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [Naive UI 官方文档](https://www.naiveui.com/)
