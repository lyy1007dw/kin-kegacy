# å°ç¨‹åºå®¶è°±æ ‘å½“å‰ç”¨æˆ·æ ‡è¯†ä¼˜åŒ–

## éœ€æ±‚è¯´æ˜

å½“å‰å°ç¨‹åºç«¯å®¶è°±æ ‘ä¸­ï¼Œåªåœ¨è‡ªå·±åˆ›å»ºçš„å®¶è°±é‡Œæ ‡æ˜ç”¨æˆ·èº«ä»½ï¼Œåœ¨ç”³è¯·åŠ å…¥çš„å®¶è°±ä¸­æ²¡æœ‰æ ‡æ˜ã€‚è¿™å¯¼è‡´ç”¨æˆ·æ‰¾ä¸åˆ°è‡ªå·±åœ¨æ—è°±ä¸­çš„ä½ç½®ã€‚

## ä¼˜åŒ–ç›®æ ‡

1. åœ¨å®¶è°±æ ‘ä¸­æ¸…æ™°æ ‡è¯†å½“å‰ç”¨æˆ·èº«ä»½
2. æ— è®ºæ˜¯åˆ›å»ºçš„å®¶è°±è¿˜æ˜¯åŠ å…¥çš„å®¶è°±ï¼Œéƒ½èƒ½çœ‹åˆ°"æˆ‘"çš„ä½ç½®

## é€»è¾‘è®¾è®¡

### æ ‡è¯†è§„åˆ™

| ç”¨æˆ·è§’è‰² | æ˜¾ç¤ºæ ‡è¯† | è¯´æ˜ |
|----------|----------|------|
| åˆ›å»ºè€… | ğŸ‘‘ åˆ›å»ºè€… | å®¶è°±çš„åˆ›å»ºè€… |
| ç®¡ç†å‘˜ | ğŸ“› ç®¡ç†å‘˜ | å®¶è°±çš„ç®¡ç†å‘˜ |
| æ™®é€šæˆå‘˜ | ğŸ‘¤ æˆ‘ | å®¶è°±çš„æ™®é€šæˆå‘˜ |
| æœªç™»å½•/éæˆå‘˜ | æ— æ ‡è¯† | ä¸æ˜¾ç¤º |

### æ•°æ®æ¥æº

é€šè¿‡ `user_genealogy` è¡¨æŸ¥è¯¢å½“å‰ç”¨æˆ·åœ¨è¯¥å®¶è°±ä¸­çš„è§’è‰²ï¼š

```sql
SELECT role FROM user_genealogy 
WHERE user_id = #{currentUserId} AND genealogy_id = #{familyId}
```

- `ADMIN` + æ˜¯åˆ›å»ºè€… â†’ æ˜¾ç¤º"åˆ›å»ºè€…"
- `ADMIN` â†’ æ˜¾ç¤º"ç®¡ç†å‘˜"
- `MEMBER` â†’ æ˜¾ç¤º"æˆ‘"

## åç«¯å®ç°

### FamilyTreeService æ”¹é€ 

```java
public List<TreeNodeVO> getFamilyTree(Long familyId, Long currentUserId) {
    // 1. è·å–å®¶è°±æ ‘ç»“æ„
    List<TreeNodeVO> tree = buildFamilyTree(familyId);
    
    // 2. è·å–å½“å‰ç”¨æˆ·åœ¨è¯¥å®¶è°±ä¸­çš„è§’è‰²
    UserGenealogy ug = userGenealogyMapper.selectByUserAndGenealogy(currentUserId, familyId);
    
    // 3. æ ‡è®°å½“å‰ç”¨æˆ·èŠ‚ç‚¹
    if (ug != null) {
        String roleLabel = getRoleLabel(ug.getRole(), familyId, currentUserId);
        markCurrentUserNode(tree, currentUserId, roleLabel);
    }
    
    return tree;
}

private String getRoleLabel(String role, Long familyId, Long userId) {
    // åˆ¤æ–­æ˜¯å¦æ˜¯åˆ›å»ºè€…
    Family family = familyMapper.selectById(familyId);
    if (family.getCreatedBy().equals(userId)) {
        return "åˆ›å»ºè€…";
    }
    
    // åˆ¤æ–­è§’è‰²
    if ("ADMIN".equals(role)) {
        return "ç®¡ç†å‘˜";
    }
    
    return "æˆ‘";
}

private void markCurrentUserNode(List<TreeNodeVO> tree, Long userId, String roleLabel) {
    for (TreeNodeVO node : tree) {
        if (userId.equals(node.getUserId())) {
            node.setCurrentUser(true);
            node.setCurrentUserLabel(roleLabel);
            break;
        }
    }
}
```

### TreeNodeVO æ‰©å±•

```java
@Data
@Builder
public class TreeNodeVO {
    private Long id;
    private String name;
    private String gender;
    private String avatar;
    private Long userId;          // å…³è”çš„ç”¨æˆ·ID
    private Boolean currentUser;   // æ˜¯å¦å½“å‰ç”¨æˆ·
    private String currentUserLabel;  // å½“å‰ç”¨æˆ·æ ‡è¯†
    // ... å…¶ä»–å­—æ®µ
}
```

## å‰ç«¯å®ç°

### æˆå‘˜èŠ‚ç‚¹æ¸²æŸ“

```vue
<template>
  <view class="tree-node" :class="{ 'is-current-user': node.currentUser }">
    <image :src="node.avatar || defaultAvatar" class="avatar" />
    <view class="info">
      <view class="name-row">
        <text class="name">{{ node.name }}</text>
        <!-- å½“å‰ç”¨æˆ·æ ‡è¯† -->
        <text v-if="node.currentUser" class="user-badge">
          {{ node.currentUserLabel }}
        </text>
      </view>
      <text v-if="node.gender" class="gender">{{ node.gender }}</text>
    </view>
  </view>
</template>

<style lang="scss" scoped>
.tree-node {
  display: flex;
  align-items: center;
  padding: 20rpx;
  background: #fff;
  border-radius: 12rpx;
  
  &.is-current-user {
    background: #e8f5e9;
    border: 2rpx solid #4caf50;
  }
  
  .avatar {
    width: 80rpx;
    height: 80rpx;
    border-radius: 50%;
    margin-right: 20rpx;
  }
  
  .name-row {
    display: flex;
    align-items: center;
    
    .name {
      font-size: 32rpx;
      font-weight: 500;
    }
    
    .user-badge {
      margin-left: 12rpx;
      padding: 4rpx 12rpx;
      font-size: 24rpx;
      color: #4caf50;
      background: #c8e6c9;
      border-radius: 8rpx;
    }
  }
  
  .gender {
    font-size: 24rpx;
    color: #999;
    margin-top: 4rpx;
  }
}
</style>
```

### å¤šè§’è‰²æ˜¾ç¤ºä¼˜åŒ–

å¦‚æœç”¨æˆ·åœ¨åŒä¸€å®¶è°±ä¸­æœ‰å¤šä¸ªèº«ä»½ï¼ˆå¦‚æ—¢æ˜¯æˆå‘˜åˆæ˜¯ç®¡ç†å‘˜ï¼‰ï¼Œä¼˜å…ˆçº§æ˜¾ç¤ºï¼š

```
åˆ›å»ºè€… > ç®¡ç†å‘˜ > æˆ‘
```

```vue
<text v-if="node.currentUser" class="user-badge">
  <text v-if="isCreator">ğŸ‘‘ åˆ›å»ºè€…</text>
  <text v-else-if="isAdmin">ğŸ“› ç®¡ç†å‘˜</text>
  <text v-else>ğŸ‘¤ æˆ‘</text>
</text>
```

## æ¥å£å“åº”ç¤ºä¾‹

```json
{
  "id": 1,
  "name": "å¼ ä¸‰",
  "avatar": "https://xxx.com/avatar.jpg",
  "userId": 100,
  "currentUser": true,
  "currentUserLabel": "æˆ‘",
  "children": [
    {
      "id": 2,
      "name": "å¼ å››",
      "currentUser": false,
      "children": []
    }
  ]
}
```

## æµ‹è¯•ç”¨ä¾‹

| åœºæ™¯ | é¢„æœŸæ˜¾ç¤º |
|------|----------|
| ç”¨æˆ·æ˜¯å®¶è°±åˆ›å»ºè€… | ğŸ‘‘ åˆ›å»ºè€… |
| ç”¨æˆ·æ˜¯å®¶è°±ç®¡ç†å‘˜ï¼ˆéåˆ›å»ºè€…ï¼‰ | ğŸ“› ç®¡ç†å‘˜ |
| ç”¨æˆ·æ˜¯æ™®é€šæˆå‘˜ | ğŸ‘¤ æˆ‘ |
| ç”¨æˆ·ä¸æ˜¯è¯¥å®¶è°±æˆå‘˜ | æ— æ ‡è¯† |
| å¤šä¸ªæˆå‘˜èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªæ˜¯å½“å‰ç”¨æˆ· | ä»…åœ¨å¯¹åº”èŠ‚ç‚¹æ˜¾ç¤ºæ ‡è¯† |

## äº¤ä»˜ç‰©

- [ ] TreeNodeVO å¢åŠ å­—æ®µ
- [ ] FamilyTreeService æ ‡è¯†é€»è¾‘
- [ ] å‰ç«¯èŠ‚ç‚¹æ¸²æŸ“æ”¹é€ 
- [ ] æ ·å¼ä¼˜åŒ–
